description: Loads environment variables and creates a deployment

parameters:
  cluster:
    description: The target Kubernetes cluster
    type: string
  team:
    description: The team name used for this deployment
    type: string
    default: $TEAM_NAME
  configuration:
    description: Which configuration to use, this is usually default, but can be seen as the old fasit environments
    type: string
    default: default
  github_token:
    description: Token used to access github resources and to create a github deployment, by default it will use the deployment-cli command to generate a installation token
    type: string
    default: $(deployment-cli token)
  naiserator_template_name:
    description: Name of template used for creating the Kubernetes resource
    type: string
    default: naiserator.yaml
  application_name:
    description: Name of application
    type: string
    default: ${CIRCLE_PROJECT_REPONAME}
  version:
    description: Version to inject into naiserator template
    type: string
    default: ${IMAGE_VERSION}
  config_repo:
    description: Which repository that contains the nais.yaml and json configurations
    type: string
    default: syfonais

docker:
  - image: "navikt/deployment-cli:8f43b88bea10759913a98659f1a63009903ca2c4"
steps:
  - workspace-restore
  - load-persisted-env
  - deploy-create:
      cluster: <<parameters.cluster>>
      team: <<parameters.team>>
      configuration: <<parameters.configuration>>
      github_token: <<parameters.github_token>>
      naiserator_template_name: <<parameters.naiserator_template_name>>
      application_name: <<parameters.application_name>>
      version: <<parameters.version>>
      config_repo: <<parameters.config_repo>>